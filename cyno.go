package cyno

import (
	"crypto/sha1"
	"encoding/hex"
	"net/http"
	"strconv"
	"time"

	"github.com/gin-gonic/gin"
)

/*
                                         '   '' _/?; ' '''
                                     .!-' '  ' `[[$?. '''
                                    ,*@?,      ^{*##*,  '
                                   .o#$*,   ' :[{$$%*&-'
                             ''   _?#%$&,    .([%$$$o*%{,  '' ''
                             '  .[%%$%$$:   '^/?#%$$*oo&&^'  '''
                               -??&$%%%#-  '-%&$%%$$*o*o*${` '''
                             .[&o%$%%%%@~  `?$%%%%%$&/**oo&?; ''
                            ;?&/%$%%%%%@~  ;#%%%%%%%$o/ooo/?%: '
                     '' '' ;&?[&$&%%%&%#_  ;@%&%%%%%$?[{////*&, '
                     '''  ,?o(o$&&&&&&$%;  `?#&&%%%%%$/([{{/{?{ '
                      '' `*o|[%%&&&&&&@o`   _$$&&&%%%$&(([[[{/?;
'''''' '''''''         ' |?||/$&?&&?&$@(,:_--(@#%&&&&&$/|(({([*(.   '
 ''''',;,,,,;_`       ' .&((|{$&???%$$$&?%%&%&%%$$%%%%%?(([[~~_!(`  '
'''''';;-;;_,,'        '|?[{||*&&$$???|{/^|%?????$%&&%$$o(|{**o((.
'''' ',_:;;:,,`       :[|_~/[{o&$%?&?[(//[~*$????%#$?&&&%%&[^[&o;'
'''''::,_~.-;;_.''''  _{-{/{[{&#&&?{{o/(|{o~[&?*&$$$&&&&&&%$o--{,
 '' ',,;`;,:.,;`'' '   ~?@*|{%#$%[(o/(^[{!/{;o%&#$$$&?&&&&&&$%o!
'''  `,;',:;,`  '''' '' (o|?&%#%!|/(?[|o{[o^:&#$%$$&?&&&&&&%$(&%_   '
'  '`_,;;_;;,;' '''''  -/|&??#@|://|[////[:-?#$%$$&????&%%%o!{#@%!.
 ' ._;._.-:;,::`''''  :*[??*&$#?~_{/[{/|_-{##%$$%????&&*{|!(?$&##$*.     `:,'''
'''',:;,;_;,.:;'  '' `/(o&???$$$${_^/|_-o$#$%$$?*????%|:^/%$&&%$&&$*.._!{{{*. '
 ''' ,:,::__:, '' '' ^/;^&???%$$%(~|(^_!%#$$$%**????&*-_{#&?&&%$%$?#%*??&?|&:
'''' '-__;::::.'    ./|:[%???%$$%?%##%?&$$%$&*??&&&&%*^~_!&%&*%%$%&@%%&&%[*-`
' '' ;:,.-_,,-;'''``-o__?&&&?%$%$$$$$$$$%%$$&%##$#*o?%%*!~([/?&%$$?#$*??&&?o([`
 ''''.:^:,;___`'`o/{?/^*$&[|*##$$$$$$$$$#####$o(|{o.'`;^{??%@#@%%##&%#%????&|{{' '
'''' ;_:,,.;-_;''*(o&##$[,;'`!#@@#########@#?(!||~{/''`''._^{#@*{$#$$%*%&?&{[*`    '
'''' ,-,;__::_;' -*&*|, ^~'''-?$#@@@@@@#?&/!({o?&?#{`'`',~;',({{$#$@$**&$*(o.
  '''`,;-,;__;:`;[&[;''`^^'```''._----__:-o!*%?&$$%?[[_'''`-~, ',_~[@#??????[-.
 '' .;,,--~;,:' ~?|%%*o_'```''`:`'.,'' ,*[{*-|??%o**-|(;``'._~^-^/*&%$&??&?!?_
 ''',,::::;:;:;''|//#@$^'``'`.:(-'`[-''.{(;_'.*{(%^^o_'[*|_;.`;*?(#&o{^#%?*|*|'
''''':;,~~:--.;` .o?%o;''`.;_^(:`-/o` :{~.;;.'~{~^-~!,:-;!/{|-;;({o#/&,-%&|o^'
  '  '`';:;_:;:''o*!-..;:_--!^_^/{o:,!(_,;;;:,.:^~-_,;:;:.|#&?*[/[&%// ,(*~' '
       ':;,_-,` '_?(---~^^|[{{o{-|{!(-_:;;;;;:::;;;:::::,;&%o*&&?!;*@oo- '`   '
'      '::^,;. '' .!?&&&|??((~:,;^~:,;;;;;;;;:::::,,:::;;(#?**??{:-%#$//,    ''
        '_;:;' '   :&?$$:{{,;;;:;;;;;;;;;,;;;;;;;:;;:;;_|&&****&*~^/$@?/o;   '
       ''_-: '''  -%&*%@!!*.;:;;;;;;;;;,_|_,;;;;;;;,,:^{o|/*?*???(o-[@$o/&~  '
       ''.;.''  `!*&**%@/,{/;,;;;;;;;;;,:~:;;;;,,,;_^{/(,_*o?*?*&[^/:[@%{{$|'
         ' '' '-*&?o**&$[:_!/(-:,,,,,,,;,,,,,;:-^|({o|;' ~**?o?o&*_^[|?#&[/@{`
       ''''  ;/$$%o***?%^_---^([(!!|^~~_:_-~~|/!~-^~,'''`^?*?o?**&{-|(~$%&([&*`
       ''' `|%#?o/**o*$/:_^[,;---||^!|(???&%$%%%{_,''`.__-&*?o?**o((-_o$&*|/?/'  ' ''
       '' :*#$/[***o%%^^|*-.;`::{o!^|({??***o&[,'`;_^^_`_%*?****|_^-!%?%{-^*['  ''
         ~%$$o*[{&o*o%$(|^{_.^,''_/{(&/^o|-?/-|-[|:-:;;-[(?***o?**[o~~~-o*?&!||?^ ''
        |#%%o{/(?*o*o$(:-!(/|!-`' [@/~-?&;-&([/__o&?/{/?|[&o?o?/{|-(_~-{**&{^([*,  '
       !$&%*(*(/&o***$^;/o:{[|({|:;#o([/[({[/|,.(%o^:,.,^{*&o?/[([[.^(^-|*o??!||o('  '
      _%&%&{/~{o/***$^(/^~(~,/|[{~.;-~~~:,![/*((/,.;;,;^[%/((!^~-~~&[|{/[??[^([o; '
  '   {$&?{([{|[[[{{/?/*|(*[|/%(!{{;__:::::;/$?&{|{*_:--_!|o?~|(((^:.` ',(*&%?|[|*~ ''
      ;-,`' `!{{/o//[/&ooo//*[//{[[(|!!!!^||||!^~^(([(|!^~/[^:`        '.,_~!|[?-  '
*/

// 大风机关赛诺 专打喜欢CC攻击和越权的小朋友
func Default() gin.HandlerFunc {
	return func(c *gin.Context) {
		cp := sha1.New()
		// 生成请求sha1 requestid并传递下去
		host := c.Request.Host
		uri := c.Request.RequestURI
		ip := c.RemoteIP()
		ua := c.Request.Header.Get("User-Agent")
		t := time.Now().UTC().UnixMicro()
		// 根据这个内容生产request id
		// 请求URL
		cp.Write([]byte(uri))
		cp.Write([]byte(ip))
		cp.Write([]byte(ua))
		cp.Write([]byte(strconv.FormatInt(t, 18)))
		c.Writer.Header().Add("Cyno-RequestID", hex.EncodeToString(cp.Sum(nil)))
		// userid
		cp.Reset()
		cp.Write([]byte(host))
		cp.Write([]byte(ip))
		cp.Write([]byte(ua))
		c.Writer.Header().Add("Cyno-ClientID", hex.EncodeToString(cp.Sum(nil)))

		// 你被大风机关盯上了！
		var locked bool = false

		// 威胁分数判断 查看是否有UA和referer

		currentTime := time.Now()
		if c.HandlerName() != "routes.HandleNotFound" && locked {
			reqid := c.Writer.Header().Get("Cyno-Requestid")
			clid := c.Writer.Header().Get("Cyno-Clientid")
			c.JSON(http.StatusForbidden, gin.H{
				"code":      -1,
				"stable":    false,
				"message":   "大风机关赛诺盯上你了(您的网络环境存在安全风险 我们无法提供服务)[Errno -1]",
				"time":      currentTime,
				"requestID": reqid,
				"clientID":  clid,
			})
			c.Abort()
		}

		c.Next()
	}
}
